<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Basavara Manager</title>
<style>
*{box-sizing:border-box;font-family:Arial;margin:0;padding:0;}
body{background:#f4f6f8;}
.hidden{display:none;}
.box{max-width:1200px;margin:15px auto;background:#fff;padding:15px;border-radius:10px;}
h2{color:#2ecc71;margin-bottom:10px;}
input,select,button{padding:8px;margin:4px;}
button{background:#2ecc71;color:#fff;border:none;border-radius:5px;cursor:pointer;}
button.red{background:#e74c3c;}
button.blue{background:#3498db;}
.top{display:flex;flex-wrap:wrap;gap:5px;align-items:center;}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#2ecc71;color:#fff;}
.ok{color:green;font-weight:bold;}
.no{color:red;font-weight:bold;}
.year{color:red;font-size:14px;margin-left:5px;}
@media(max-width:600px){
 .top{flex-direction:column;}
 button,input,select{width:100%;}
 table{font-size:12px;}
}
@media print{
 .top,button,#filter,#historyContainer{display:none;}
 body{background:#fff;}
}
/* Transaction blocks */
.payment-container { font-family: Arial, sans-serif; padding: 10px; max-height:400px; overflow-y:auto; border:1px solid #ccc; border-radius:5px; margin-top:15px; background:#fff; }
.transaction { 
    border: 1px solid #ccc; 
    padding: 10px; 
    margin-bottom: 10px; 
    cursor: pointer; 
    background-color: #f9f9f9; 
    border-radius:5px;
}
.transaction:hover { background-color: #e0e0e0; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h2>Login</h2>
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="msg"></p>
</div>

<!-- APP -->
<div class="box hidden" id="app">
<h2 id="title">Basavara Manager <span class="year"></span></h2>

<div class="top">
<select id="lang" onchange="setLang()">
<option value="en">EN</option>
<option value="bn">BN</option>
</select>
<select id="month"></select>
<button onclick="addPerson()" id="addBtn">Add Bharatia</button>
<button onclick="exportCSV()" id="exBtn">Export CSV</button>
<button class="blue" onclick="printReport()">Print</button>
<input id="filter" placeholder="Filter name / flat / phone" onkeyup="draw()">
<button class="red" onclick="logout()">Logout</button>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>Flat</th>
<th>Name</th>
<th>Rent</th>
<th>Paid</th>
<th>Due</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<h3 id="sumTitle">Summary</h3>
<ul id="summary"></ul>
<p><b>Total Rent:</b> <span id="tRent">0</span></p>
<p><b>Total Paid:</b> <span id="tPaid">0</span></p>
<p><b>Total Due:</b> <span id="tDue">0</span></p>

<!-- PAYMENT HISTORY BELOW -->
<div id="historyContainer" class="payment-container hidden">
  <h2>Payment History</h2>
  <div id="paymentContainer"></div>
</div>

</div>

<script>
/* LOGIN */
function login(){
 if(user.value==="aminul1234" && pass.value==="ami123@"){
  localStorage.setItem("login","1");
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
 } else msg.innerText="Wrong login";
}
function logout(){ localStorage.removeItem("login"); location.reload(); }
if(localStorage.getItem("login")){
 loginBox.classList.add("hidden"); app.classList.remove("hidden");
}

/* YEAR */
document.querySelector(".year").innerText=new Date().getFullYear();

/* MONTH */
const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
months.forEach(m=>month.innerHTML+=`<option>${m}</option>`);
month.selectedIndex=new Date().getMonth();
month.onchange=draw;

/* DATA */
let data=JSON.parse(localStorage.getItem("rent"))||{};
let currentHistoryIndex=-1;

/* ADD PERSON */
function addPerson(){
 let flat=prompt("Flat No"); if(!flat)return;
 let name=prompt("Name"); if(!name)return;
 let phone=prompt("Phone Number");
 let nid=prompt("NID Number");
 let father=prompt("Father's Name");
 let mother=prompt("Mother's Name");
 let address=prompt("Permanent Address");
 let rent=+prompt("Total Rent",0);
 months.forEach(m=>{
   if(!data[m]) data[m]=[];
   data[m].push({flat,name,phone,nid,father,mother,address,rent,paid:0,history:[]});
 });
 save(); draw();
}

/* DRAW TABLE */
function draw(){
 let m=month.value;
 list.innerHTML=""; summary.innerHTML="";
 let totalRent=0,totalPaid=0;
 if(!data[m]){tRent.innerText=tPaid.innerText=tDue.innerText=0; return;}
 let f=filter.value.toLowerCase();
 data[m].forEach((p,i)=>{
  if(!(p.name+p.flat+p.phone).toLowerCase().includes(f)) return;
  let due=p.rent-p.paid; totalRent+=p.rent; totalPaid+=p.paid;
  list.innerHTML+=`
<tr>
<td>${p.flat}</td><td>${p.name}</td><td>${p.rent}</td>
<td>${p.paid}</td><td>${due}</td>
<td class="${due<=0?'ok':'no'}">${due<=0?'‚úîÔ∏è':'‚ùå'}</td>
<td>
<button onclick="pay(${i})">Pay</button>
<button onclick="openHistory(${i})" class="blue">History</button>
<button onclick="details(${i})">üë§</button>
<button onclick="edit(${i})">‚úèÔ∏è</button>
<button class="red" onclick="del(${i})">‚ùå</button>
</td>
</tr>`;
 });
 data[m].forEach(p=>{
  let li=document.createElement("li");
  li.innerText=`Flat ${p.flat} | ${p.name} | Phone: ${p.phone} | Due: ‡ß≥${p.rent-p.paid}`;
  summary.appendChild(li);
 });
 tRent.innerText=totalRent;
 tPaid.innerText=totalPaid;
 tDue.innerText=totalRent-totalPaid;
}

/* PAY */
function pay(i){
 let m=month.value;
 let a=+prompt("Paid Amount"); 
 if(!a) return;
 data[m][i].paid += a;
 data[m][i].history.push({amount:a, date:new Date().toLocaleDateString()});
 save(); draw();
 openHistory(i); // show below table
}

/* DETAILS */
function details(i){
 let p=data[month.value][i];
 alert(
  "Name: "+p.name+
  "\nFlat: "+p.flat+
  "\nPhone: "+p.phone+
  "\nNID: "+p.nid+
  "\nFather: "+p.father+
  "\nMother: "+p.mother+
  "\nAddress: "+p.address
 );
}

/* PAYMENT HISTORY - blocks below table */
function openHistory(i){
 currentHistoryIndex = i;
 let m = month.value;
 let h = data[m][i].history;
 let container = document.getElementById("historyContainer");
 let paymentDiv = document.getElementById("paymentContainer");
 paymentDiv.innerHTML = "";
 if(!h.length){
   paymentDiv.innerHTML = "<p>No payment yet</p>";
 } else {
   h.forEach((x, idx)=>{
     let div = document.createElement("div");
     div.className = "transaction";
     div.innerHTML = `<p>Transaction ${idx+1} - ‡ß≥${x.amount}</p>`;
     div.onclick = ()=>alert(`Payment Details:\nAmount: ‡ß≥${x.amount}\nDate: ${x.date}`);
     paymentDiv.appendChild(div);
   });
 }
 container.classList.remove("hidden");
}

/* EDIT / DELETE */
function edit(i){
 let m=month.value;
 let r=+prompt("Edit Rent",data[m][i].rent);
 if(r>=0)data[m][i].rent=r; save(); draw();
}
function del(i){
 let m = month.value;
 data[m].splice(i,1);
 save(); draw();
}

/* SAVE */
function save(){ localStorage.setItem("rent",JSON.stringify(data)); }

/* EXPORT CSV */
function exportCSV(){
 let m=month.value; if(!data[m])return alert("No data");
 let csv="Flat,Name,Phone,NID,Father,Mother,Address,Rent,Paid,Due\n";
 data[m].forEach(p=>{
  csv+=`${p.flat},${p.name},${p.phone},${p.nid},${p.father},${p.mother},${p.address},${p.rent},${p.paid},${p.rent-p.paid}\n`;
 });
 let a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
 a.download=m+"_rent.csv"; a.click();
}

/* PRINT */
function printReport(){window.print();}

/* LANGUAGE */
function setLang(){
 if(lang.value==="bn"){
  title.innerText="‡¶¨‡¶æ‡¶∏‡¶æ‡¶≠‡¶æ‡ßú‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞";
  addBtn.innerText="‡¶≠‡¶æ‡ßú‡¶æ‡¶ü‡¶ø‡ßü‡¶æ ‡¶Ø‡ßã‡¶ó";
  exBtn.innerText="CSV ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°";
  filter.placeholder="‡¶®‡¶æ‡¶Æ / ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü / ‡¶´‡ßã‡¶®";
  sumTitle.innerText="‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™";
 } else location.reload();
}

draw();
</script>
</body>
</html>
