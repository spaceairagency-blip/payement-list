<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="image.png">
<title>Basavara Manager</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f4f6f8}
.hidden{display:none}
.box{max-width:1200px;margin:15px auto;background:#fff;padding:15px;border-radius:10px}
h2{color:#2ecc71;margin:0 0 10px}
input,select,button{padding:8px;margin:4px}
button{background:#2ecc71;color:#fff;border:none;border-radius:5px;cursor:pointer}
button.red{background:#e74c3c}
button.blue{background:#3498db}
.top{display:flex;flex-wrap:wrap;gap:5px;align-items:center}

.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#2ecc71;color:#fff}
.ok{color:green;font-weight:bold}
.no{color:red;font-weight:bold}

.year{color:red;font-size:14px;margin-left:5px}

@media(max-width:600px){
 .top{flex-direction:column}
 button,input,select{width:100%}
 table{font-size:12px}
}

@media print{
 .top,button,#filter{display:none}
 body{background:#fff}
}

/* HISTORY MODAL */
#historyModal{
 position:fixed; inset:0; background:rgba(0,0,0,.6);
 display:flex; align-items:center; justify-content:center; z-index:999;
}
#historyModal .card{
 position:relative;
 background:#fff; width:95%; max-width:500px;
 border-radius:10px; padding:15px;
}
.closeBtn{
 position:absolute; top:10px; right:10px; padding:5px 10px;
 cursor:pointer;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h2>Login</h2>
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<p id="msg"></p>
</div>

<!-- APP -->
<div class="box hidden" id="app">
<h2 id="title">Basavara Manager <span class="year"></span></h2>

<div class="top">
<select id="lang" onchange="setLang()">
<option value="en">EN</option>
<option value="bn">BN</option>
</select>

<select id="month"></select>

<button onclick="addPerson()" id="addBtn">Add Bharatia</button>
<button onclick="exportCSV()" id="exBtn">Export CSV</button>
<button class="blue" onclick="printReport()">Print</button>

<input id="filter" placeholder="Filter name / flat / phone" onkeyup="draw()">
<button class="red" onclick="logout()">Logout</button>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>Flat</th>
<th>Name</th>
<th>Rent</th>
<th>Paid</th>
<th>Due</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<h3 id="sumTitle">Summary</h3>
<ul id="summary"></ul>
<p><b>Total Rent:</b> <span id="tRent">0</span></p>
<p><b>Total Paid:</b> <span id="tPaid">0</span></p>
<p><b>Total Due:</b> <span id="tDue">0</span></p>
</div>

<script>
/* LOGIN */
function login(){
 if(user.value==="aminul1234" && pass.value==="ami123@"){
  localStorage.setItem("login","1");
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
 } else msg.innerText="Wrong login";
}
function logout(){ localStorage.removeItem("login"); location.reload(); }
if(localStorage.getItem("login")){
 loginBox.classList.add("hidden"); app.classList.remove("hidden");
}

/* YEAR */
document.querySelector(".year").innerText=new Date().getFullYear();

/* MONTH */
const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
months.forEach(m=>month.innerHTML+=`<option>${m}</option>`);
month.selectedIndex=new Date().getMonth();
month.onchange=draw;

/* DATA */
let data=JSON.parse(localStorage.getItem("rent"))||{};

/* ADD PERSON (All Months) */
function addPerson(){
 let flat=prompt("Flat No"); if(!flat)return;
 let name=prompt("Name"); if(!name)return;
 let phone=prompt("Phone Number");
 let nid=prompt("NID Number");
 let father=prompt("Father's Name");
 let mother=prompt("Mother's Name");
 let address=prompt("Permanent Address");
 let rent=+prompt("Total Rent",0);

 months.forEach(m=>{
   if(!data[m]) data[m]=[];
   data[m].push({flat,name,phone,nid,father,mother,address,rent,paid:0,history:[]});
 });
 save(); draw();
}

/* DRAW */
function draw(){
 let m=month.value;
 list.innerHTML=""; summary.innerHTML="";
 let totalRent=0,totalPaid=0;
 if(!data[m]){tRent.innerText=tPaid.innerText=tDue.innerText=0;return;}
 let f=filter.value.toLowerCase();

 data[m].forEach((p,i)=>{
  if(!(p.name+p.flat+p.phone).toLowerCase().includes(f))return;
  let due=p.rent-p.paid; totalRent+=p.rent; totalPaid+=p.paid;
  list.innerHTML+=`
<tr>
<td>${p.flat}</td><td>${p.name}</td><td>${p.rent}</td>
<td>${p.paid}</td><td>${due}</td>
<td class="${due<=0?'ok':'no'}">${due<=0?'‚úîÔ∏è':'‚ùå'}</td>
<td>
<button onclick="pay(${i})">Pay</button>
<button class="blue" onclick="openHistory(${i})">üìú</button>
<button onclick="details(${i})">üë§</button>
<button onclick="edit(${i})">‚úèÔ∏è</button>
<button class="red" onclick="del(${i})">‚ùå</button>
</td>
</tr>`;
 });

 data[m].forEach(p=>{
  let li=document.createElement("li");
  li.innerText=`Flat ${p.flat} | ${p.name} | Phone: ${p.phone} | Due: ${p.rent-p.paid}`;
  summary.appendChild(li);
 });

 tRent.innerText=totalRent;
 tPaid.innerText=totalPaid;
 tDue.innerText=totalRent-totalPaid;
}

/* PAY */
function pay(i){
 let m=month.value;
 let a=+prompt("Paid Amount"); if(!a)return;
 data[m][i].paid+=a;
 data[m][i].history.push({amount:a,date:new Date().toLocaleDateString()});
 save();draw();
}

/* DETAILS */
function details(i){
 let p=data[month.value][i];
 alert(
  "Name: "+p.name+
  "\nFlat: "+p.flat+
  "\nPhone: "+p.phone+
  "\nNID: "+p.nid+
  "\nFather: "+p.father+
  "\nMother: "+p.mother+
  "\nAddress: "+p.address
 );
}

/* PAYMENT HISTORY + EDIT */
let currentHistoryIndex=-1;
function openHistory(i){
 currentHistoryIndex=i;
 let h = data[month.value][i].history;
 let historyList = document.getElementById("historyList");
 historyList.innerHTML = "";
 if(!h.length){
  historyList.innerHTML="<tr><td colspan='3'>No payment yet</td></tr>";
 } else {
  h.forEach((x,idx)=>{
   historyList.innerHTML+=`
   <tr>
    <td>${x.date}</td>
    <td>${x.amount}</td>
    <td><button onclick="editHistory(${idx})">‚úèÔ∏è</button></td>
   </tr>`;
  });
 }
 document.getElementById("historyModal").classList.remove("hidden");
}

function editHistory(idx){
 if(currentHistoryIndex===-1) return;
 let m=month.value;
 let p = data[m][currentHistoryIndex];
 let oldAmount=p.history[idx].amount;
 let newAmount = +prompt("Edit Amount", oldAmount);
 if(isNaN(newAmount)||newAmount<0) return alert("Invalid amount");
 p.history[idx].amount=newAmount;
 p.paid = p.history.reduce((sum,x)=>sum+x.amount,0);
 save(); draw();
 openHistory(currentHistoryIndex);
}

function closeHistory(){
 document.getElementById("historyModal").classList.add("hidden");
 currentHistoryIndex=-1;
}

/* EDIT / DELETE (Delete only current month) */
function edit(i){
 let m=month.value;
 let r=+prompt("Edit Rent",data[m][i].rent);
 if(r>=0)data[m][i].rent=r; save(); draw();
}
function del(i){
 let m = month.value;
 data[m].splice(i,1); // only current month
 save(); draw();
}

/* SAVE */
function save(){ localStorage.setItem("rent",JSON.stringify(data)); }

/* EXPORT */
function exportCSV(){
 let m=month.value; if(!data[m])return alert("No data");
 let csv="Flat,Name,Phone,NID,Father,Mother,Address,Rent,Paid,Due\n";
 data[m].forEach(p=>{
  csv+=`${p.flat},${p.name},${p.phone},${p.nid},${p.father},${p.mother},${p.address},${p.rent},${p.paid},${p.rent-p.paid}\n`;
 });
 let a=document.createElement("a");
 a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
 a.download=m+"_rent.csv"; a.click();
}

/* PRINT */
function printReport(){window.print();}

/* LANGUAGE */
function setLang(){
 if(lang.value==="bn"){
  title.innerText="‡¶¨‡¶æ‡¶∏‡¶æ‡¶≠‡¶æ‡ßú‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶æ‡¶∞";
  addBtn.innerText="‡¶≠‡¶æ‡ßú‡¶æ‡¶ü‡¶ø‡ßü‡¶æ ‡¶Ø‡ßã‡¶ó";
  exBtn.innerText="CSV ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°";
  filter.placeholder="‡¶®‡¶æ‡¶Æ / ‡¶´‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü / ‡¶´‡ßã‡¶®";
  sumTitle.innerText="‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™";
 } else location.reload();
}

draw();
</script>
</body>
</html>

